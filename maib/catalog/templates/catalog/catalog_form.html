{% extends 'base.html' %}
{% load static %}

{% block title %}{% if carpet %}Редактировать ковер{% else %}Добавить ковер{% endif %}{% endblock %}

{% block content %}
<style>
  .form-card{max-width:1100px;margin:16px auto;background:#fff;border:1px solid #e5e5e5;border-radius:16px;box-shadow:0 8px 24px #0001;padding:20px}
  .form-title{font-size:1.6rem;font-weight:700;margin-bottom:10px;text-align:center}
  .preview-card{border:1px solid #eee;border-radius:12px;padding:10px;background:#fafafa}
  .preview-card img{width:100%;height:auto;border-radius:8px}
</style>

<div class="form-card">
  <div class="form-title">{% if carpet %}Редактировать ковер{% else %}Добавить ковер{% endif %}</div>

  <!-- enctype обязательно для загрузки файла -->
  <form method="post" enctype="multipart/form-data" class="row g-3" autocomplete="off">
    {% csrf_token %}

    <!-- Левая колонка -->
    <div class="col-12 col-md-7">
      <div class="row g-3">
        <div class="col-12 col-md-6">
          <label class="form-label" for="{{ form.collection.id_for_label }}">Коллекция</label>{{ form.collection }}
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label" for="{{ form.style.id_for_label }}">Стиль</label>{{ form.style }}
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label" for="{{ form.code.id_for_label }}">Код модели</label>{{ form.code }}
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label" for="{{ form.color.id_for_label }}">Цвет основы</label>{{ form.color }}
        </div>

        <div class="col-12">
          <label class="form-label" for="{{ form.image.id_for_label }}">Изображение (URL)</label>
          {{ form.image }}
          <div class="form-text">Формат: https://…/F053D_BLUE_BLUE.jpg (или загрузите файл ниже)</div>
        </div>

        <!-- Поле загрузки файла (уйдет в Supabase, URL запишется в image) -->
        <div class="col-12">
          <label class="form-label" for="{{ form.upload.id_for_label }}">Загрузить файл</label>
          {{ form.upload }}
        </div>

        <div class="col-12">
          <label class="form-label" for="{{ form.name.id_for_label }}">Название ковра</label>{{ form.name }}
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label" for="{{ form.loom_width.id_for_label }}">Ширина станка</label>{{ form.loom_width }}
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label" for="{{ form.pile_height.id_for_label }}">Высота ворса</label>{{ form.pile_height }}
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label" for="{{ form.quality.id_for_label }}">Качество</label>{{ form.quality }}
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label" for="{{ form.weight.id_for_label }}">Вес (кг/м²)</label>{{ form.weight }}
        </div>

        <!-- Состав нитей -->
        <div class="col-12">
          <label class="form-label">Состав</label>
          <div class="row g-2">
            <div class="col-6 col-md-2">{{ form.thread_percent_left }}</div>
            <div class="col-6 col-md-4">{{ form.thread_material_left }}</div>
            <div class="col-6 col-md-2">{{ form.thread_percent_right }}</div>
            <div class="col-6 col-md-4">{{ form.thread_note }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Правая колонка: превью -->
    <div class="col-12 col-md-5">
      <div class="preview-card">
        <div class="small text-muted mb-2">Превью</div>
        <img id="carpetPreview"
             src="{% if form.instance %}{{ form.instance.get_image_url }}{% else %}{% static 'img/carpet_placeholder.jpg' %}{% endif %}"
             alt="preview"
             onerror="this.onerror=null;this.src='{% static 'img/carpet_placeholder.jpg' %}'">
      </div>
    </div>

    <!-- Кнопки -->
    <div class="col-12 d-grid gap-2 mt-2">
      <button type="submit" class="btn btn-primary btn-lg">Сохранить</button>
      <a href="{% url 'collection_cards' %}" class="btn btn-outline-secondary btn-lg">Отмена</a>
    </div>
  </form>
</div>

<!-- Небольшой JS: обновляет превью при вводе URL или выборе файла -->
<script>
(function(){
  const urlInput = document.getElementById('{{ form.image.id_for_label }}');
  const fileInput = document.getElementById('{{ form.upload.id_for_label }}');
  const img = document.getElementById('carpetPreview');
  const placeholder = "{% static 'img/carpet_placeholder.jpg' %}";

  if (urlInput) {
    urlInput.addEventListener('input', () => {
      const v = (urlInput.value || '').trim();
      img.src = v || placeholder;
    });
  }
  if (fileInput) {
    fileInput.addEventListener('change', () => {
      const f = fileInput.files && fileInput.files[0];
      if (f) img.src = URL.createObjectURL(f);
    });
  }
})();
</script>
{% endblock %}
